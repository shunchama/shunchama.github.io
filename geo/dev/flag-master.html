<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FLAG-MASTER (Review Mode)</title>
    <style>
      :root {
        --primary: #3498db;
        --secondary: #2ecc71;
        --accent: #e67e22;
        --danger: #e74c3c;
        --review: #f1c40f;
        --bg: #f0f2f5;
      }
      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        text-align: center;
        background: var(--bg);
        margin: 0;
        padding: 0;
      }

      /* Navigation */
      nav {
        background: #fff;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: center;
        gap: 20px;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .nav-btn {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 16px;
        font-weight: bold;
        color: #7f8c8d;
        border-bottom: 3px solid transparent;
      }
      .nav-btn.active {
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
      }

      .container {
        max-width: 800px;
        margin: 20px auto;
        padding: 15px;
      }
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }

      /* Panels */
      .panel {
        background: white;
        max-width: 450px;
        margin: 0 auto 20px;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
      }
      .region-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 15px;
      }
      .region-btn {
        padding: 8px;
        font-size: 12px;
        cursor: pointer;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        transition: 0.2s;
      }
      .region-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .region-btn.review-btn-mode {
        border-color: var(--review);
        color: var(--review);
        font-weight: bold;
      }
      .region-btn.review-btn-mode.active {
        background: var(--review);
        color: white;
      }

      /* Reset Button */
      .reset-btn {
        width: 100%;
        margin-top: 10px;
        padding: 8px;
        font-size: 13px;
        cursor: pointer;
        background: #95a5a6;
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold;
      }

      /* Quiz area */
      .flag-box {
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        border: 1px solid #f0f0f0;
        border-radius: 10px;
      }
      #flag-img {
        max-height: 90%;
        max-width: 90%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      #answer-area {
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* Review Star Button */
      .review-toggle {
        background: none;
        border: 2px solid var(--review);
        color: var(--review);
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        margin-bottom: 10px;
        transition: 0.3s;
        display: none; /* Hidden until quiz starts */
      }
      .review-toggle.active {
        background: var(--review);
        color: white;
      }

      #action-btn {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        cursor: pointer;
        background: var(--secondary);
        color: white;
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 0 #27ae60;
      }
      #action-btn:active {
        transform: translateY(2px);
        box-shadow: none;
      }

      /* List Grid */
      .list-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
      }
      .flag-item {
        background: white;
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        position: relative;
      }
      .flag-item img {
        width: 100%;
        height: 80px;
        object-fit: contain;
        border: 1px solid #eee;
        margin-bottom: 8px;
      }
      .list-star {
        position: absolute;
        top: 5px;
        right: 5px;
        color: var(--review);
        font-size: 18px;
      }

      #loading {
        margin-top: 100px;
        font-size: 20px;
        color: var(--primary);
        font-weight: bold;
      }
      footer {
        margin-top: 40px;
        padding: 20px;
        color: #7f8c8d;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <nav>
      <button class="nav-btn" onclick="location.href = 'https://shunchama.github.io/geo/'">„Éù„Éº„Çø„É´„Å´Êàª„Çã</button>
      <button class="nav-btn active" onclick="showPage('quiz-page', this)">ÂõΩÊóó„ÇØ„Ç§„Ç∫</button>
      <button class="nav-btn" onclick="showPage('list-page', this)">ÂõΩÊóó‰∏ÄË¶ß</button>
    </nav>

    <div class="container">
      <div id="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>

      <div id="quiz-page" class="page">
        <div class="panel">
          <div class="region-grid" id="quiz-regions"></div>
          <button class="reset-btn" onclick="resetCurrentQuiz()">„É™„Çª„ÉÉ„Éà</button>
        </div>

        <div class="panel">
          <div id="progress" style="margin-bottom: 10px; font-weight: bold; color: #555">0 / 0</div>
          <div class="flag-box"><img id="flag-img" src="" alt="Flag" /></div>
          
          <div id="answer-area">
            <button id="review-btn" class="review-toggle" onclick="toggleReview()">‚òÜ Âæ©Áøí„Å´ËøΩÂä†</button>
            <p id="name-jp" style="font-size: 24px; font-weight: bold; margin: 0"></p>
            <p id="name-en" style="color: #95a5a6; margin: 5px 0"></p>
            <a id="map-link" href="#" target="_blank" style="display: none; color: var(--accent); text-decoration: none; font-size: 14px; font-weight: bold; margin-bottom: 10px;">üìç Â†¥ÊâÄ„ÇíÁ¢∫Ë™ç</a>
          </div>
          
          <button id="action-btn">Á≠î„Åà„ÇíË¶ã„Çã</button>
        </div>
      </div>

      <div id="list-page" class="page">
        <div class="panel" style="max-width: 600px">
          <div class="region-grid" id="list-regions"></div>
        </div>
        <div class="list-grid" id="flag-list-container"></div>
      </div>
    </div>

    <script>
      let allCountries = [];
      let quizList = [];
      let currentQuizIndex = 0;
      let isShowingAnswer = false;
      let currentRegion = "All";
      
      // Load review list from LocalStorage
      let reviewedIds = JSON.parse(localStorage.getItem('flagReviewList')) || [];

      const regions = [
        { id: "All", name: "„Åô„Åπ„Å¶" },
        { id: "Asia", name: "„Ç¢„Ç∏„Ç¢" },
        { id: "Africa", name: "„Ç¢„Éï„É™„Ç´" },
        { id: "Europe", name: "Ê¨ßÂ∑û" },
        { id: "North America", name: "ÂåóÁ±≥" },
        { id: "South America", name: "ÂçóÁ±≥" },
        { id: "Oceania", name: "„Ç™„Çª„Ç¢„Éã„Ç¢" },
        { id: "Review", name: "‚≠ê Âæ©Áøí" } // Added Review category
      ];

      async function loadData() {
        try {
          const res = await fetch("https://restcountries.com/v3.1/all?fields=name,translations,flags,region,subregion,maps,independent,unMember,cca2");
          const data = await res.json();

          const filteredData = data.filter(c => 
            c.independent === true || c.unMember === true || ["TW", "HK", "MO"].includes(c.cca2)
          );

          allCountries = filteredData.map(c => {
            let r = c.region;
            if (c.subregion === "South America") r = "South America";
            if (["North America", "Central America", "Caribbean"].includes(c.subregion)) r = "North America";

            return {
              id: c.cca2, // Used for localStorage key
              nameJp: c.translations.jpn ? c.translations.jpn.common : c.name.common,
              nameEn: c.name.common,
              flag: c.flags.png,
              region: r,
              mapUrl: c.maps.googleMaps,
            };
          }).sort((a, b) => a.nameJp.localeCompare(b.nameJp, "ja"));

          initUI();
          document.getElementById("loading").style.display = "none";
          showPage("quiz-page", document.querySelectorAll(".nav-btn")[1]);
        } catch (e) {
          document.getElementById("loading").textContent = "„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ";
        }
      }

      function initUI() {
        const quizRegContainer = document.getElementById("quiz-regions");
        const listRegContainer = document.getElementById("list-regions");

        regions.forEach(reg => {
          // Buttons for Quiz page
          const b1 = document.createElement("button");
          b1.className = "region-btn";
          if (reg.id === "Review") b1.classList.add("review-btn-mode");
          if (reg.id === "All") b1.classList.add("active");
          b1.textContent = reg.name;
          b1.onclick = () => {
            currentRegion = reg.id;
            document.querySelectorAll("#quiz-regions .region-btn").forEach(b => b.classList.remove("active"));
            b1.classList.add("active");
            startQuiz(reg.id);
          };
          quizRegContainer.appendChild(b1);

          // Buttons for List page
          const b2 = document.createElement("button");
          b2.className = "region-btn";
          if (reg.id === "Review") b2.classList.add("review-btn-mode");
          if (reg.id === "All") b2.classList.add("active");
          b2.textContent = reg.name;
          b2.onclick = () => {
            document.querySelectorAll("#list-regions .region-btn").forEach(b => b.classList.remove("active"));
            b2.classList.add("active");
            renderList(reg.id);
          };
          listRegContainer.appendChild(b2);
        });
        startQuiz("All");
        renderList("All");
      }

      function showPage(pageId, btn) {
        document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
        document.getElementById(pageId).classList.add("active");
        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      }

      function startQuiz(region) {
        if (region === "Review") {
          quizList = allCountries.filter(c => reviewedIds.includes(c.id));
          if (quizList.length === 0) {
            alert("Âæ©Áøí„É™„Çπ„Éà„ÅåÁ©∫„Åß„Åô„ÄÇ„Åæ„Åö„ÅØ‰ªñ„ÅÆÂú∞Âüü„Åß‚≠ê„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶ËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
            // Switch back to "All"
            const allBtn = document.querySelector("#quiz-regions .region-btn");
            allBtn.click();
            return;
          }
        } else {
          quizList = region === "All" ? [...allCountries] : allCountries.filter(c => c.region === region);
        }
        quizList.sort(() => Math.random() - 0.5);
        currentQuizIndex = 0;
        showQuestion();
      }

      function resetCurrentQuiz() {
        startQuiz(currentRegion);
      }

      function showQuestion() {
        isShowingAnswer = false;
        const c = quizList[currentQuizIndex];
        document.getElementById("flag-img").src = c.flag;
        document.getElementById("name-jp").textContent = "";
        document.getElementById("name-en").textContent = "";
        document.getElementById("map-link").style.display = "none";
        document.getElementById("action-btn").textContent = "Á≠î„Åà„ÇíË¶ã„Çã";
        document.getElementById("progress").textContent = `ÂïèÈ°å: ${currentQuizIndex + 1} / ${quizList.length}`;
        
        // Setup review star button
        const revBtn = document.getElementById("review-btn");
        revBtn.style.display = "inline-block";
        updateReviewBtnUI();
      }

      function toggleReview() {
        const currentCountry = quizList[currentQuizIndex];
        const index = reviewedIds.indexOf(currentCountry.id);
        
        if (index > -1) {
          reviewedIds.splice(index, 1);
        } else {
          reviewedIds.push(currentCountry.id);
        }
        
        localStorage.setItem('flagReviewList', JSON.stringify(reviewedIds));
        updateReviewBtnUI();
      }

      function updateReviewBtnUI() {
        const btn = document.getElementById("review-btn");
        const currentCountry = quizList[currentQuizIndex];
        if (reviewedIds.includes(currentCountry.id)) {
          btn.classList.add("active");
          btn.textContent = "‚òÖ Âæ©Áøí‰∏≠";
        } else {
          btn.classList.remove("active");
          btn.textContent = "‚òÜ Âæ©Áøí„Å´ËøΩÂä†";
        }
      }

      document.getElementById("action-btn").onclick = () => {
        if (!isShowingAnswer) {
          const c = quizList[currentQuizIndex];
          document.getElementById("name-jp").textContent = c.nameJp;
          document.getElementById("name-en").textContent = c.nameEn;
          document.getElementById("map-link").href = c.mapUrl;
          document.getElementById("map-link").style.display = "inline-block";
          document.getElementById("action-btn").textContent = "Ê¨°„Å∏";
          isShowingAnswer = true;
        } else {
          currentQuizIndex = (currentQuizIndex + 1) % quizList.length;
          showQuestion();
        }
      };

      function renderList(region) {
        const container = document.getElementById("flag-list-container");
        container.innerHTML = "";
        
        let list;
        if (region === "Review") {
          list = allCountries.filter(c => reviewedIds.includes(c.id));
        } else {
          list = region === "All" ? allCountries : allCountries.filter(c => c.region === region);
        }

        list.forEach(c => {
          const div = document.createElement("div");
          div.className = "flag-item";
          const isReviewed = reviewedIds.includes(c.id) ? '<span class="list-star">‚òÖ</span>' : '';
          div.innerHTML = `
            ${isReviewed}
            <img src="${c.flag}" alt="${c.nameJp}" loading="lazy">
            <div style="font-size: 13px; font-weight: bold;">${c.nameJp}</div>
            <a href="${c.mapUrl}" target="_blank" style="font-size: 11px; color: var(--accent); text-decoration: none;">üìç Maps</a>
          `;
          container.appendChild(div);
        });
      }

      loadData();
    </script>
    <hr>
    <footer>¬© 2026 shunchama. Built with GitHub Pages.</footer>
  </body>
</html>